# syntax=docker/dockerfile:1.4
# -----------------------------------------
# .NET SDK Dev Image (Backend)
# Shared across team via GHCR
# -----------------------------------------
ARG DOTNET_VERSION=9.0
FROM mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}-bookworm-slim

# Re-declare for metadata / logs if needed
ARG DOTNET_VERSION

# Use bash so RUN chains behave like your frontend image
SHELL ["/bin/bash", "-lc"]

# Reduce noise & telemetry in dev containers
ENV DOTNET_CLI_TELEMETRY_OPTOUT=1 \
    DOTNET_NOLOGO=1 \
    VSCODE_SERVER_DIR=/home/vscode/.vscode-server-shared

# -------------------------------------------------
# Create non-root dev user (vscode, uid 1000)
# -------------------------------------------------
RUN id -u vscode &>/dev/null || useradd -u 1000 -m vscode

# Prepare workspace + VS Code shared server dir
RUN mkdir -p /workspaces/app \
 && mkdir -p /home/vscode/.vscode-server-shared \
 && chown -R vscode:vscode /workspaces \
 && chown -R vscode:vscode /home/vscode/.vscode-server-shared

# Switch to non-root dev user
USER vscode
WORKDIR /workspaces/app

# Optional: log versions once at build time (handy when debugging)
RUN dotnet --info || true

# Devcontainer will override CMD; keep it idle by default
CMD ["sleep", "infinity"]
